"""Supabase è¿æ¥ - å•ä¾‹æ¨¡å¼"""

import os
from typing import Any, Optional, Dict
from threading import Lock
from supabase import create_client, Client
from ymda.settings import Settings
from ymda.utils.logger import get_logger

logger = get_logger(__name__)


class Database:
    """æ•°æ®åº“è¿æ¥ç®¡ç†å™¨ - Supabaseï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""
    
    _instance: Optional['Database'] = None
    _lock = Lock()
    
    def __new__(cls, settings: Optional[Settings] = None):
        """å•ä¾‹æ¨¡å¼å®ç°"""
        if cls._instance is None:
            with cls._lock:
                if cls._instance is None:
                    if settings is None:
                        # å°è¯•ä»ç¯å¢ƒå˜é‡åˆ›å»º Settings
                        settings = Settings()
                    cls._instance = super().__new__(cls)
                    cls._instance._initialized = False
        return cls._instance
    
    def __init__(self, settings: Optional[Settings] = None):
        """åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼ˆä»…åœ¨é¦–æ¬¡è°ƒç”¨æ—¶æ‰§è¡Œï¼‰"""
        if hasattr(self, '_initialized') and self._initialized:
            return
        
        if settings is None:
            # å°è¯•ä»ç¯å¢ƒå˜é‡åˆ›å»º Settings
            settings = Settings()
        
        self.settings = settings
        self.client: Optional[Client] = None
        self._connect()
        self._initialized = True
    
    def _connect(self):
        """
        è¿æ¥åˆ° Supabase
        
        supabase-py åº“ä¼šè‡ªåŠ¨è®¾ç½®ä»¥ä¸‹ headers:
        - apikey: {supabase_key}
        - Authorization: Bearer {supabase_key}
        """
        try:
            # è¯¦ç»†æ£€æŸ¥é…ç½®é¡¹
            missing_configs = []
            if not self.settings.supabase_url:
                missing_configs.append("SUPABASE_URL")
            if not self.settings.supabase_key:
                missing_configs.append("SUPABASE_SERVICE_ROLE_KEY æˆ– SUPABASE_KEY")
            
            if missing_configs:
                logger.warning(
                    f"Supabaseé…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•è¿æ¥æ•°æ®åº“ã€‚ç¼ºå¤±çš„é…ç½®é¡¹: {', '.join(missing_configs)}ã€‚"
                    f"è¯·æ£€æŸ¥ .env æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡æ˜¯å¦å·²æ­£ç¡®è®¾ç½®ã€‚"
                )
                return
            
            # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† service_role keyï¼ˆæ¨èç”¨äºæœåŠ¡ç«¯æ“ä½œï¼‰
            is_service_role = os.getenv("SUPABASE_SERVICE_ROLE_KEY") is not None
            if not is_service_role:
                logger.warning(
                    "âš ï¸  è­¦å‘Š: æœªæ£€æµ‹åˆ° SUPABASE_SERVICE_ROLE_KEYï¼Œä½¿ç”¨çš„æ˜¯ SUPABASE_KEYã€‚"
                    "å¯¹äºæ•°æ®åº“å†™å…¥æ“ä½œï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ service_role keyï¼ˆç»•è¿‡ RLS é™åˆ¶ï¼‰ã€‚"
                    "anon key å¯èƒ½å› æƒé™ä¸è¶³å¯¼è‡´ 401 é”™è¯¯ã€‚"
                )
            
            # åˆ›å»º Supabase å®¢æˆ·ç«¯
            # supabase-py åº“ä¼šè‡ªåŠ¨è®¾ç½®ä»¥ä¸‹ headersï¼ˆä¸ requests ç¤ºä¾‹ä¸€è‡´ï¼‰:
            # - apikey: {supabase_key}
            # - Authorization: Bearer {supabase_key}
            # - Content-Type: application/json
            self.client = create_client(
                self.settings.supabase_url,
                self.settings.supabase_key
            )
            
            key_type = "service_role" if is_service_role else "anon/key"
            logger.info(
                f"Supabaseæ•°æ®åº“è¿æ¥æˆåŠŸï¼ˆå•ä¾‹ï¼‰- URL: {self.settings.supabase_url[:30]}... "
                f"Keyç±»å‹: {key_type}ï¼Œå·²è‡ªåŠ¨è®¾ç½® apikey å’Œ Authorization Bearer headers"
            )
        except Exception as e:
            error_msg = str(e)
            # æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é”™è¯¯
            if '401' in error_msg or 'Invalid API key' in error_msg or 'Unauthorized' in error_msg:
                logger.error(
                    f"è¿æ¥Supabaseå¤±è´¥ï¼ˆè®¤è¯é”™è¯¯ï¼‰: {error_msg}\n"
                    f"ğŸ’¡ æç¤º: è¯·ç¡®ä¿ä½¿ç”¨çš„æ˜¯æœ‰æ•ˆçš„ service_role key æˆ– anon keyã€‚"
                    f"supabase-py åº“ä¼šè‡ªåŠ¨è®¾ç½® apikey å’Œ Authorization Bearer headersã€‚"
                )
            else:
                logger.error(f"è¿æ¥Supabaseå¤±è´¥: {error_msg}")
            raise
    
    def get_client(self) -> Client:
        """è·å–æ•°æ®åº“å®¢æˆ·ç«¯"""
        if not self.client:
            raise RuntimeError("Database client not initialized. è¯·æ£€æŸ¥Supabaseé…ç½®ã€‚")
        return self.client
    
    def is_connected(self) -> bool:
        """æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²è¿æ¥"""
        return self.client is not None
    
    def create_ym_table_if_not_exists(self) -> bool:
        """
        åˆ›å»º ym è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        
        Returns:
            æˆåŠŸè¿”å› Trueï¼Œå¤±è´¥è¿”å› False
        """
        create_table_sql = """
        CREATE TABLE IF NOT EXISTS public.ym (
          id           BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
          slug         TEXT NOT NULL UNIQUE,
          name         TEXT NOT NULL,
          category     TEXT NOT NULL,
          description  TEXT,
          created_at   TIMESTAMPTZ DEFAULT now(),
          updated_at   TIMESTAMPTZ DEFAULT now()
        );
        
        CREATE INDEX IF NOT EXISTS idx_ym_slug ON public.ym(slug);
        CREATE INDEX IF NOT EXISTS idx_ym_category ON public.ym(category);
        """
        
        result = self.execute_sql_via_management_api(create_table_sql)
        if result:
            logger.info("âœ“ ym è¡¨åˆ›å»ºæˆåŠŸæˆ–å·²å­˜åœ¨")
            return True
        else:
            logger.warning("âš  æ— æ³•é€šè¿‡ Management API åˆ›å»ºè¡¨ï¼Œè¯·æ‰‹åŠ¨åœ¨ Supabase Dashboard ä¸­åˆ›å»º")
            return False
    
    def execute_sql_via_management_api(self, sql: str) -> Optional[Dict[str, Any]]:
        """
        é€šè¿‡ Management API æ‰§è¡Œ SQL æŸ¥è¯¢
        
        Args:
            sql: è¦æ‰§è¡Œçš„ SQL è¯­å¥
            
        Returns:
            æŸ¥è¯¢ç»“æœå­—å…¸ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å› None
        """
        if not self.settings.supabase_access_token or not self.settings.supabase_project_id:
            logger.warning(
                "Management API é…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•æ‰§è¡Œ SQLã€‚"
                "éœ€è¦è®¾ç½® SUPABASE_ACCESS_TOKEN å’Œ SUPABASE_PROJECT_IDã€‚"
            )
            return None
        
        try:
            import requests
            
            # Management API endpoint for executing SQL
            mgmt_base = "https://api.supabase.com"
            mgmt_url = f"{mgmt_base}/v1/projects/{self.settings.supabase_project_id}/database/query"
            
            headers = {
                'Authorization': f'Bearer {self.settings.supabase_access_token}',
                'Content-Type': 'application/json',
            }
            
            payload = {
                'query': sql
            }

            print(payload)
            
            response = requests.post(mgmt_url, headers=headers, json=payload, timeout=30)
            
            if response.status_code in (200, 201):
                logger.info("âœ“ SQL æ‰§è¡ŒæˆåŠŸ (via Management API)")
                return response.json()
            elif response.status_code == 400:
                error_msg = response.text[:200]
                logger.error(f"âœ— SQL æ‰§è¡Œå¤±è´¥ (è¯­æ³•é”™è¯¯): {error_msg}")
                return None
            elif response.status_code == 401:
                logger.error(
                    "âš  Management API è®¤è¯å¤±è´¥ã€‚"
                    "access_token å¯èƒ½æ²¡æœ‰æ‰€éœ€æƒé™æˆ–å·²è¿‡æœŸã€‚"
                )
                return None
            elif response.status_code == 404:
                logger.error(
                    "âš  Management API ç«¯ç‚¹æœªæ‰¾åˆ°ã€‚"
                    "è¯·æ£€æŸ¥ SUPABASE_PROJECT_ID æ˜¯å¦æ­£ç¡®ã€‚"
                )
                return None
            else:
                logger.error(
                    f"âš  Management API è¿”å› {response.status_code}: {response.text[:200]}"
                )
                return None
        except ImportError:
            logger.error("âš  requests åº“æœªå®‰è£…ï¼Œæ— æ³•ä½¿ç”¨ Management API")
            return None
        except Exception as e:
            logger.error(f"Management API æ‰§è¡Œå¤±è´¥: {e}")
            return None
    
    def close(self):
        """å…³é—­æ•°æ®åº“è¿æ¥"""
        logger.info("Closing database connection")
        self.client = None
        Database._instance = None
        self._initialized = False


def get_database(settings: Optional[Settings] = None) -> Optional[Database]:
    """
    è·å–æ•°æ®åº“å•ä¾‹å®ä¾‹ï¼ˆæ¨èä½¿ç”¨æ­¤æ–¹æ³•è·å–æ•°æ®åº“å®ä¾‹ï¼‰
    
    Args:
        settings: Settings å®ä¾‹ï¼ˆå¯é€‰ï¼Œé¦–æ¬¡è°ƒç”¨æ—¶å¦‚æœä¸æä¾›åˆ™ä»ç¯å¢ƒå˜é‡åˆ›å»ºï¼‰
        
    Returns:
        Database å®ä¾‹ï¼Œå¦‚æœé…ç½®ä¸å®Œæ•´æˆ–è¿æ¥å¤±è´¥åˆ™è¿”å› None
    """
    try:
        if settings is None:
            settings = Settings()
        
        # åœ¨åˆ›å»º Database ä¹‹å‰å…ˆæ£€æŸ¥é…ç½®
        if not settings.supabase_url or not settings.supabase_key:
            missing = []
            if not settings.supabase_url:
                missing.append("SUPABASE_URL")
            if not settings.supabase_key:
                missing.append("SUPABASE_KEY æˆ– SUPABASE_SERVICE_ROLE_KEY")
            logger.warning(
                f"æ•°æ®åº“é…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•åˆå§‹åŒ–è¿æ¥ã€‚ç¼ºå¤±é…ç½®: {', '.join(missing)}ã€‚"
                f"è¯·ç¡®ä¿ .env æ–‡ä»¶å­˜åœ¨ä¸”åŒ…å«å¿…è¦çš„é…ç½®é¡¹ã€‚"
            )
            return None
        
        db = Database(settings)
        if not db.is_connected():
            logger.warning("æ•°æ®åº“è¿æ¥æœªå»ºç«‹ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œè¿æ¥")
            return None
        return db
    except Exception as e:
        logger.error(f"åˆå§‹åŒ–æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        return None

